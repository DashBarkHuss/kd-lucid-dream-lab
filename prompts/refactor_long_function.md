This function is long. Can you see if it can be refactored to be more readable, DRY, SOLID, efficient, manitainable, etc?
